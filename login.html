<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ログイン - テスト点数記録表</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <main class="container">
    <header class="site-header card">
      <h1>ログイン</h1>
    </header>

    <section class="card">
      <p>学籍番号と誕生日でログインします。</p>
      <label style="display:block;margin-bottom:8px">学籍番号
        <input id="acctId" placeholder="学籍番号 (例: 202312345)" />
      </label>
      <label style="display:block;margin-bottom:12px">誕生日
        <input id="acctBday" placeholder="誕生日 (YYYYMMDD)" />
      </label>
      <!-- Buttons stacked to avoid confusion -->
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button id="registerBtn" class="btn">新規登録（登録して自動ログインします）</button>
        <button id="loginBtn" class="btn">ログイン</button>
        <a href="index.html" class="btn" style="text-align:center;">戻る</a>
      </div>
      <div id="msg" style="margin-top:12px;color:#b91c1c"></div>
    </section>

  </main>

  <script src="app.js" defer></script>
  <script>
    // Wait for app.js to expose methods on window._debug
    function waitForDebug(cb){
      if(window._debug && window._debug.registerAccount && window._debug.loginAccount) return cb();
      setTimeout(()=>waitForDebug(cb), 200);
    }
    document.addEventListener('DOMContentLoaded', ()=>{
      const idEl = document.getElementById('acctId');
      const bEl = document.getElementById('acctBday');
      const msg = document.getElementById('msg');
      waitForDebug(()=>{
        document.getElementById('registerBtn').addEventListener('click', async ()=>{
          msg.textContent = '';
          try{
            await window._debug.registerAccount(idEl.value.trim(), bEl.value.trim());
            // after successful registration, auto-login and redirect
            const ok = await window._debug.loginAccount(idEl.value.trim(), bEl.value.trim());
            if(ok){ window.location.href = 'index.html'; }
          }catch(e){ msg.style.color='#b91c1c'; msg.textContent = e.message; }
        });
        document.getElementById('loginBtn').addEventListener('click', async ()=>{
          msg.textContent = '';
          try{
            // special admin shortcut: acctId === 'admin' and empty password -> go to admin dashboard
            const idVal = idEl.value.trim();
            const bVal = bEl.value.trim();
            if(idVal.toLowerCase() === 'admin' && bVal === ''){
              // redirect to admin page where the real admin password is requested
              window.location.href = 'admin.html';
              return;
            }
            const ok = await window._debug.loginAccount(idVal, bVal);
            if(ok){ window.location.href = 'index.html'; }
          }catch(e){ msg.style.color='#b91c1c'; msg.textContent = e.message; }
        });
      });
    });
  </script>
</body>
</html>
